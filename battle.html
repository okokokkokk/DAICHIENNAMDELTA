<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Đại Chiến Nam Delta</title>
    <link rel="icon" type="image/jpg" href="logo-a2.jpg">
    <style>
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div class="win-screen" id="winScreen">
        <img src="win.jpg">
        <div class="message-container">
            <p id="winMessage"></p>
        </div>
        <div class="button-container">
            <button id="playAgainWin" class="play-again-button">Play Again</button>
            <button id="goBackWin" class="go-back-button">Quay lại</button>
        </div>
    </div>

    <div class="game-over-screen" id="gameOverScreen">
        <img src="thua.jpg">
        <div class="button-container">
            <button id="playAgainLose" class="play-again-button">Play Again</button>
            <button id="goBackLose" class="go-back-button">Quay lại</button>
        </div>
    </div>

    <!-- Load images -->
    <img id="player1Image" src="khai.jpg" style="display:none;">
    <img id="player2Image" src="namdelta.jpg" style="display:none;">
    <img id="sword1Image" src="kiem1.png" style="display:none;">
    <img id="sword2Image" src="kiem2.png" style="display:none;">

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            background-image: url(background.png);
            background-repeat: no-repeat;
            background-size: cover;
        }

        canvas {
            display: block;
            margin: 0 auto;
        }

        .win-screen, .game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            display: none;
            z-index: 100;
        }

        .win-screen {
            display: none;
        }

        .game-over-screen {
            display: none;
        }

        .controls {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        .control-button-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
        }

        .control-button {
            width: 60px;
            height: 60px;
            background-color: rgba(255, 255, 255, 0.8);
            border: 2px solid #fff;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
        }

        .win-screen, .game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            display: none;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .win-screen img, .game-over-screen img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .win-screen .button-container, .game-over-screen .button-container {
            position: fixed;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .message-container {
            background-color: rgb(160, 230, 20);
            color: red;
            font-size: 30px;
            text-align: center;
            align-items: center;
            margin: 0 auto;
            position: relative;
            z-index: 101;
            padding: 20px;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.6);
        }


        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }

        .play-again-button, .go-back-button {
            padding: 10px 20px;
            font-size: 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 150px;
            text-align: center;
            outline: none; /* Loại bỏ đường viền mặc định của nút */
        }

        .play-again-button {
            background-color: #4CAF50;
            color: white;
        }

        .play-again-button:hover {
            background-color: #45a049;
        }

        .go-back-button {
            background-color: #f44336;
            color: white;
        }

        .go-back-button:hover {
            background-color: #e53935;
        }


        .health-bar {
            height: 10px;
            border-radius: 5px;
            border: 2px solid #000;
            position: absolute;
        }

        .health-bar-background {
            background-color: green;
            height: 100%;
            border-radius: 5px;
        }

        .health-bar-lost {
            background-color: white;
            height: 100%;
            border-radius: 5px;
        }


    </style>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const PLAYER_SIZE = 64;
        const ENEMY_SIZE = 64;
        const HEALTH_BAR_HEIGHT = 10;
        const PLAYER_SPEED = 200;
        const MAX_HEALTH = 200;

        let player1 = {
            x: 50,
            y: canvas.height / 2 - PLAYER_SIZE / 2,
            width: PLAYER_SIZE,
            height: PLAYER_SIZE,
            health: MAX_HEALTH,
            color: 'green',
            move: { up: false, down: false, left: false, right: false },
            attack: false,
            image: new Image()
        };

        let player2 = {
            x: canvas.width - 50 - PLAYER_SIZE,
            y: canvas.height / 2 - PLAYER_SIZE / 2,
            width: PLAYER_SIZE,
            height: PLAYER_SIZE,
            health: MAX_HEALTH,
            color: 'blue',
            move: { up: false, down: false, left: false, right: false },
            attack: false,
            image: new Image()
        };

        function loadCharacterImages() {
            const selectedPlayer = JSON.parse(localStorage.getItem('selectedPlayer'));
            const selectedEnemy = JSON.parse(localStorage.getItem('selectedEnemy'));

            if (selectedPlayer && selectedEnemy) {
                player1.image.src = selectedPlayer.image;
                player2.image.src = selectedEnemy.image;
            }
        }

        let enemies = [];
        let gameOver = false;

        function setupGame() {
            player1.health = MAX_HEALTH;
            player2.health = MAX_HEALTH;
            enemies = [];
            gameOver = false;

            // Reset các thuộc tính khác nếu cần
            player1.x = 50;
            player1.y = canvas.height / 2 - PLAYER_SIZE / 2;
            player1.move = { up: false, down: false, left: false, right: false }; // Reset move

            player2.x = canvas.width - 50 - PLAYER_SIZE;
            player2.y = canvas.height / 2 - PLAYER_SIZE / 2;
            player2.move = { up: false, down: false, left: false, right: false }; // Reset move

            sword1Image = document.getElementById('sword1Image');
            sword2Image = document.getElementById('sword2Image');

            // Hiển thị lại canvas và ẩn các màn hình kết thúc trò chơi
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('winScreen').style.display = 'none';
            loadCharacterImages();
        }

        function drawPlayer(player, swordImageLeft, swordImageRight, isLeft) {
            // Vẽ nhân vật
            ctx.drawImage(player.image, player.x, player.y, player.width, player.height);

            // Xác định kiếm dựa trên hướng di chuyển
            let swordImage;
            let swordX, swordY;

            if (player === player2) {
                // Nhân vật 2: kiếm bên trái khi di chuyển trái, kiếm bên phải khi di chuyển phải
                swordImage = player.move.right ? swordImageRight : swordImageLeft;
            } else {
                swordImage = player.move.left ? swordImageLeft : swordImageRight;
                // Nhân vật 1: kiếm bên phải khi di chuyển phải, kiếm bên trái khi di chuyển trái
            }

            // Xác định vị trí của thanh kiếm
            if (player === player2) {
                swordX = player.x + (player.move.right ? player.width - 20 : -30);
                // Nhân vật 2 cầm kiếm bên trái khi di chuyển trái và bên phải khi di chuyển phải
            } else {
                swordX = player.x + (player.move.left ? -30 : player.width - 20);
                // Nhân vật 1 cầm kiếm bên phải khi di chuyển phải và bên trái khi di chuyển trái
            }

            swordY = player.y + (player.height / 2 - 15); // Vị trí tay cầm kiếm (có thể điều chỉnh theo hình ảnh nhân vật)

            ctx.drawImage(swordImage, swordX, swordY, 50, 50); // Điều chỉnh kích thước kiếm theo nhu cầu

            // Vẽ thanh máu
            drawHealthBar(player.x, player.y, player.health, player.color);
        }

        function drawEnemies() {
            enemies.forEach(enemy => {
                ctx.drawImage(enemy.image, enemy.x, enemy.y, ENEMY_SIZE, ENEMY_SIZE);
                drawHealthBar(enemy.x, enemy.y, enemy.health, 'red');
            });
        }

        function movePlayer(player) {
            const deltaX = PLAYER_SPEED * (1 / 60);
            const deltaY = PLAYER_SPEED * (1 / 60);

            if (player.move.up) player.y -= deltaY;
            if (player.move.down) player.y += deltaY;
            if (player.move.left) player.x -= deltaX;
            if (player.move.right) player.x += deltaX;

            // Giới hạn di chuyển của người chơi
            if (player.y < 0) player.y = 0;
            if (player.y > canvas.height - player.height) player.y = canvas.height - player.height;
            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;
        }

        // Hàm kiểm tra va chạm
        function isColliding(p1, p2) {
            return !(p1.x + p1.width < p2.x || 
                    p1.x > p2.x + p2.width || 
                    p1.y + p1.height < p2.y || 
                    p1.y > p2.y + p2.height);
        }

        function canMove(player, deltaX, deltaY) {
            const newX = player.x + deltaX;
            const newY = player.y + deltaY;

            // Tạo một đối tượng tạm thời để kiểm tra va chạm
            const tempPlayer = {
                ...player,
                x: newX,
                y: newY
            };

            // Kiểm tra va chạm với người chơi còn lại
            const otherPlayer = (player === player1) ? player2 : player1;
            if (isColliding(tempPlayer, otherPlayer)) {
                return false; // Không thể di chuyển vì có va chạm
            }

            // Kiểm tra giới hạn di chuyển của người chơi
            if (newX < 0 || newX > canvas.width - player.width || newY < 0 || newY > canvas.height - player.height) {
                return false; // Không thể di chuyển ra ngoài canvas
            }

            return true; // Có thể di chuyển
        }

        function movePlayerWithCollisionCheck(player) {
            const deltaX = PLAYER_SPEED * (1 / 60);
            const deltaY = PLAYER_SPEED * (1 / 60);

            let moveX = 0;
            let moveY = 0;

            if (player.move.up) moveY -= deltaY;
            if (player.move.down) moveY += deltaY;
            if (player.move.left) moveX -= deltaX;
            if (player.move.right) moveX += deltaX;

            if (canMove(player, moveX, moveY)) {
                player.x += moveX;
                player.y += moveY;
            }
        }



        function drawHealthBar(x, y, health, color) {
            const healthWidth = (health / MAX_HEALTH) * PLAYER_SIZE;
            const lostWidth = PLAYER_SIZE - healthWidth;

            ctx.fillStyle = color;
            ctx.fillRect(x, y - HEALTH_BAR_HEIGHT, healthWidth, HEALTH_BAR_HEIGHT);

            ctx.fillStyle = 'white';
            ctx.fillRect(x + healthWidth, y - HEALTH_BAR_HEIGHT, lostWidth, HEALTH_BAR_HEIGHT);

            ctx.strokeStyle = 'black';
            ctx.strokeRect(x, y - HEALTH_BAR_HEIGHT, PLAYER_SIZE, HEALTH_BAR_HEIGHT);
        }

        function attackPlayer(attacker, defender) {
            const attackRange = 70; // Giảm phạm vi tấn công xuống 1px
            const knockbackDistance = 20; // Khoảng cách lùi lại khi bị tấn công

            if (attacker.attack) {
                const inRange = (Math.abs(attacker.x - defender.x) <= attackRange && Math.abs(attacker.y - defender.y) <= attackRange);
                
                if (inRange) {
                    // Tính toán đẩy lùi dựa trên hướng tấn công
                    const dx = defender.x - attacker.x;
                    const dy = defender.y - attacker.y;
                    const magnitude = Math.sqrt(dx * dx + dy * dy);
                    
                    if (magnitude > 0) {
                        // Tính toán hướng đẩy lùi
                        const knockbackX = (dx / magnitude) * knockbackDistance;
                        const knockbackY = (dy / magnitude) * knockbackDistance;

                        // Đẩy lùi defender
                        defender.x += knockbackX;
                        defender.y += knockbackY;

                        // Đảm bảo defender không ra ngoài khung màn hình
                        defender.x = Math.max(0, Math.min(canvas.width - defender.width, defender.x));
                        defender.y = Math.max(0, Math.min(canvas.height - defender.height, defender.y));

                        // Đẩy lùi attacker (nếu muốn, có thể thêm điều kiện hoặc loại bỏ)
                        attacker.x -= knockbackX;
                        attacker.y -= knockbackY;

                        // Đảm bảo attacker không ra ngoài khung màn hình
                        attacker.x = Math.max(0, Math.min(canvas.width - attacker.width, attacker.x));
                        attacker.y = Math.max(0, Math.min(canvas.height - attacker.height, attacker.y));
                    }

                    // Giảm máu của defender
                    defender.health -= 10; 
                    if (defender.health <= 0) {
                        defender.health = 0;
                        if (attacker === player1) {
                            enemies = enemies.filter(enemy => enemy !== defender);
                            if (enemies.length === 0) {
                                showWinScreen('player1');
                            }
                        } else {
                            player1.health = 0;
                            showGameOverScreen('player2');
                        }
                    }
                }
            }
        }

        function handleKeydown(event) {
            switch (event.key) {
                case 'w': player1.move.up = true; break;
                case 's': player1.move.down = true; break;
                case 'a': player1.move.left = true; break;
                case 'd': player1.move.right = true; break;
                case ' ': player1.attack = true; break;
                case 'ArrowUp': player2.move.up = true; break;
                case 'ArrowDown': player2.move.down = true; break;
                case 'ArrowLeft': player2.move.left = true; break;
                case 'ArrowRight': player2.move.right = true; break;
                case 'Enter': player2.attack = true; break;
            }
        }

        function handleKeyup(event) {
            switch (event.key) {
                case 'w': player1.move.up = false; break;
                case 's': player1.move.down = false; break;
                case 'a': player1.move.left = false; break;
                case 'd': player1.move.right = false; break;
                case ' ': player1.attack = false; break;
                case 'ArrowUp': player2.move.up = false; break;
                case 'ArrowDown': player2.move.down = false; break;
                case 'ArrowLeft': player2.move.left = false; break;
                case 'ArrowRight': player2.move.right = false; break;
                case 'Enter': player2.attack = false; break;
            }
        }

        function showGameOverScreen(winner) {
            gameOver = true;
            document.getElementById('gameOverScreen').style.display = 'block';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('winScreen').style.display = 'block';
            // In ra tên nhân vật chiến thắng ở trên cùng
            document.querySelector('.win-screen .message-container').innerText = `Người chơi thứ hai đã dành chiến thắng!`;
        }

        function showWinScreen(winner) {
            gameOver = true;
            document.getElementById('winScreen').style.display = 'block';
            document.getElementById('gameOverScreen').style.display = 'none';
            // In ra tên nhân vật chiến thắng ở trên cùng
            document.querySelector('.win-screen .message-container').innerText = `Người chơi thứ nhất đã dành chiến thắng!`;
        }


        function update() {
            if (gameOver) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            movePlayerWithCollisionCheck(player1);
            movePlayerWithCollisionCheck(player2);

            drawPlayer(player1, sword1Image, sword2Image, false); // Player1 cầm kiếm bên phải hoặc bên trái
            drawPlayer(player2, sword1Image, sword2Image, true);  // Player2 cầm kiếm bên phải hoặc bên trái

            attackPlayer(player1, player2);
            attackPlayer(player2, player1);

            requestAnimationFrame(update);
        }



        document.addEventListener('keydown', handleKeydown);
        document.addEventListener('keyup', handleKeyup);

        setupGame();
        update();

        document.getElementById('playAgainWin').addEventListener('click', function() {
            setupGame();
            document.getElementById('winScreen').style.display = 'none';
        });

        document.getElementById('goBackWin').addEventListener('click', function() {
            window.location.href = 'doikhang.html';
        });

        document.getElementById('playAgainLose').addEventListener('click', function() {
            setupGame();
            document.getElementById('WinScreen').style.display = 'none';
        });

        document.getElementById('goBackLose').addEventListener('click', function() {
            window.location.href = 'doikhang.html';
        });
        document.getElementById('playAgainWin').addEventListener('click', function() {
            location.reload(); // Làm mới trang
        });

        document.getElementById('playAgainLose').addEventListener('click', function() {
            location.reload(); // Làm mới trang
        });

    </script>
</body>
</html>
